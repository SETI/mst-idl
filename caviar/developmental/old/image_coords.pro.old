
	pro image_coords, stars, cmat, vobs, cam_params, nl, coords 

	rho_J2000=dblarr(3)
	corrected_rho_J2000=dblarr(3)
	rho_cam=dblarr(3)

	num_stars=n_elements(stars[*,0])

	coords=dblarr(num_stars,2)

	for i=0,num_stars-1 do begin

		RA=stars[i,1]/3600.0d3
		dec=stars[i,2]/3600.0d3


		r=1.0d0*cos(2.0d0*!dpi*dec/360.0d0)
		rho_J2000[0]=r*cos(2.0d0*!dpi*RA/360.0d0)
		rho_J2000[1]=r*sin(2.0d0*!dpi*RA/360.0d0)
		rho_J2000[2]=(sin(2.0d0*!dpi*dec/360.0d0))/1.0d0

		cspice_stelab,rho_J2000,vobs,corrected_rho_J2000

		d_rho_cam=cmat##corrected_rho_J2000
		rho_cam[0:2]=d_rho_cam[0,0:2]
	
		;factor=foc*sigma/rho_cam[2]
		;sample=factor*rho_cam[0]+511.5d0
		;line=factor*rho_cam[1]+511.5d0

		;factor=cam_params[0]*83.333333333d0/rho_cam[2]
		;sample=factor*rho_cam[0]+511.5d0
		;line=factor*rho_cam[1]+511.5d0

		;sample=(cam_params[0]*cam_params[4]*rho_cam[0]/rho_cam[2])+511.5d0
		;line=(cam_params[0]*cam_params[7]*rho_cam[1]/rho_cam[2])+511.5d0

		if nl eq 1024 then summ=1.0d0
		if nl eq 512 then summ=2.0d0
		if nl eq 256 then summ=4.0d0

		x=(cam_params[0]/rho_cam[2])*rho_cam[0]
		y=(cam_params[0]/rho_cam[2])*rho_cam[1]
		
		r2=(x*x)+(y*y)

		deltax=((x*r2)*cam_params[1])+((x*y)*cam_params[2])+((x*x)*cam_params[3])
		deltay=((y*r2)*cam_params[1])+((y*y)*cam_params[2])+((x*y)*cam_params[3])

		sample=((cam_params[4]/summ)*(x+deltax))+((cam_params[5]/summ)*(y+deltay))+((-1.0d0+(nl*1.0d0))/2.0d0)
		line=((cam_params[6]/summ)*(x+deltax))+((cam_params[7]/summ)*(y+deltay))+((-1.0d0+(nl*1.0d0))/2.0d0)

		coords[i,0]=line
		coords[i,1]=sample

		;if n_elements(stars[0,*]) eq 4 then stars[*,8:9]=coords[i,0:1]

	endfor

	return
	end
	      
