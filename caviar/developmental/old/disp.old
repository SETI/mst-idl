image_coords,stars,cmat,vobs,cam_params,nl,coords
image_coords,planet,cmat,vobs_planet,cam_params,nl,planet_coords
image_coords,ring,cmat,vobs_planet,cam_params,nl,ring_coords

wset,1

tv,im,/order
plots,round(coords[*,1]),round((nl-1)-coords[*,0]),psym=symbol,symsize=symbol_size,color=make_array(n_elements(stars[*,0]),value=cyan()),/device
plots,round(planet_coords[*,1]),round((nl-1)-planet_coords[*,0]),psym=planet_symbol,symsize=planet_symbol_size,color=make_array(n_elements(planet[*,0]),value=green()),/device
plots,round(ring_coords[*,1]),(nl-1)-round(ring_coords[*,0]),psym=ring_symbol,symsize=ring_symbol_size,color=make_array(n_elements(ring[*,0]),value=blue()),/device


;name='UCAC2-'+strcompress(string(long(stars[*,0])),/remove_all)
mag=(stars[*,3]/100.0)
mag=strcompress(string(mag),/remove_all)
xyouts,round(coords[*,1])+6,(nl-4)-round(coords[*,0]),s_names,color=make_array(n_elements(stars[*,0]),value=cyan()),/device
xyouts,round(coords[*,1])+6,(nl-14)-round(coords[*,0]),mag,color=make_array(n_elements(stars[*,0]),value=cyan()),/device
;xyouts,planet_coords[*,1]+6,(nl-4)-planet_coords[*,0],strcompress(string(planet[*,0]),/remove_all),/device
get_planet_name,planet[*,0],plan_names
xyouts,planet_coords[*,1]+6,(nl-4)-planet_coords[*,0],plan_names[*],color=make_array(n_elements(planet[*,0]),value=green()),/device

cspice_m2eul,cmat,3,1,3,twisto,deco,rao

rao=rao-(0.5d0*!dpi)
deco=(0.5d0*!dpi)-deco

rao=rao*360.0d0/(2.0d0*!dpi)
deco=deco*360.0d0/(2.0d0*!dpi)
twisto=twisto*360.0d0/(2.0d0*!dpi)

if rao lt 0.0d0 then rao=rao+360.0d0
if twisto lt 0.0d0 then twisto=twisto+360.0d0

print,' '
print,format='(d15.10,d15.10,d15.10)',rao,deco,twisto
print,' '

cmat_trans=transpose(cmat)
cam_offset_trans=pmat##cmat_trans
cam_offset=transpose(cam_offset_trans)

cspice_m2q,cam_offset,cam_offset_quat

print,' '
print,format='(d14.11,d14.11,d14.11,d14.11)',cam_offset_quat
print,' '

zax=[0.0d0,0.0d0,1.0d0]
pvec_d=cmat_trans##zax
pvec=dblarr(3)
pvec[0]=pvec_d[0,0]
pvec[1]=pvec_d[0,1]
pvec[2]=pvec_d[0,2]

